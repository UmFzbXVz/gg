<!DOCTYPE html>
<html lang="da">
  <head>
    <meta charset="UTF-8">
    <title>Råt og Hvidt</title>
    <link rel="stylesheet" href="style.css">
    <link rel="icon" type="image/png" href="favicon.png">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  </head>
  <body>
    <div class="page-container">
      <h1>
        <span class="title-highlight">
          <span id="rat">Råt</span> og <span id="hvidt">Hvidt</span>
        </span>
      </h1>
      <form id="searchForm" class="controls">
        <div class="input-wrapper">
          <input type="text" id="searchTerm" placeholder="søg efter..." autocomplete="off">
          <svg id="searchSpinner" class="loading-border" viewBox="0 0 300 40" preserveAspectRatio="none">
            <rect x="2" y="2" width="296" height="36" rx="6" ry="6" fill="none" stroke="#4caf50" stroke-width="5" stroke-linecap="round" />
          </svg>
        </div>
        <div class="category-selector">
          <button id="categoryButton" class="category-button" type="button">
            <img src="sorting.svg" alt="" class="category-icon">
          </button>
          <div id="categoryMenu" class="category-menu" style="display: none;">
            <div class="category-menu-title">Kategorier</div>
            <ul class="categories-list">
              <li data-value="mobler">Møbler og indretning</li>
              <li data-value="dyr">Dyr og udstyr</li>
              <li data-value="toejogboern">Tøj og børn</li>
              <li data-value="kunst">Kunst og antik</li>
              <li data-value="alting">Alting</li>
            </ul>
            <hr class="menu-divider" />
            <div class="location-selector">
              <div class="category-menu-title">Områder</div>
              <ul class="locations-list">
                <li>
                  <label>
                    <input type="checkbox" id="locationJylland" value="jylland" checked>Jylland </label>
                </li>
                <li>
                  <label>
                    <input type="checkbox" id="locationSydsjaelland" value="sydsjaelland-og-oerne"> Sydsj. og øerne </label>
                </li>
                <li>
                  <label>
                    <input type="checkbox" id="locationFyn" value="fyn"> Fyn </label>
                </li>
                <li>
                  <label>
                    <input type="checkbox" id="locationSjaelland" value="sjaelland"> Sjælland </label>
                </li>
              </ul>
            </div>
            <hr class="menu-divider" />
            <label class="bg-toggle"> Auto-opdatér <input type="checkbox" id="bgToggle" checked>
            </label>
          </div>
        </div>
      </form>
      <div id="grid"></div>
    </div>
    <script src="https://unpkg.com/@panzoom/panzoom@4.6.0/dist/panzoom.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
    <script src="scripts/gg-search.js"></script>
    <script src="scripts/dba-search.js"></script>
    <script src="scripts/reshopper-search.js"></script>
    <script src="scripts/fremviser.js"></script>
    <script src="scripts/bg.js"></script>
    <script>
(() => {
	const form = document.getElementById("searchForm");
	const input = document.getElementById("searchTerm");
	const spinner = document.getElementById("searchSpinner");
	const grid = document.getElementById("grid");
	const categoryButton = document.getElementById("categoryButton");
	const categoryMenu = document.getElementById("categoryMenu");
	const bgToggle = document.getElementById("bgToggle");
	const sentinel = document.createElement('div');

	let selectedCategory = 'mobler';
	const BATCH_SIZE = 30;
	let currentIndex = 0;
	let isFirstSearch = true;
	window.allCards = [];
	window.pendingBgSearches = [];
	window.seenAdKeys = new Set();
	sentinel.style.height = '1px';

	const observer = new IntersectionObserver(entries => {
		if (entries[0].isIntersecting) {
			renderNextBatch();
		}
	}, {
		rootMargin: '200px 0px 0px 0px'
	});

	function debounce(func, wait) {
		let timeout;
		return function(...args) {
			clearTimeout(timeout);
			timeout = setTimeout(() => func.apply(this, args), wait);
		};
	}

	bgToggle.addEventListener("change", () => {
		if (bgToggle.checked && window.bgSearch) {
			window.bgSearch.resume();
		}
	});

	const categories = {
		'mobler': {
			ggSlug: '/mobler',
			ggTitle: 'møbler',
			dbaCat: '0.78',
			reshopperFacetValue: 'Home'
		},
		'dyr': {
			ggSlug: '/dyr-og-tilbehor',
			ggTitle: 'dyr og tilbehør',
			dbaCat: '0.77',
			reshopperFacetValue: null
		},
		'kunst': {
			ggSlug: '/antikviteter-og-kunst',
			ggTitle: 'antikviteter og kunst',
			dbaCat: '0.76',
			reshopperFacetValue: null
		},
		'toejogboern': {
			ggSlug: '/born',
			ggTitle: 'børn',
			dbaCat: '0.68',
			reshopperFacetValue: 'Kids'
		},
		'alting': {
			ggSlug: '',
			ggTitle: 'alting',
			dbaCat: undefined,
			reshopperFacetValue: undefined
		}
	};

	const cardKey = (card) => card.dataset.id || card.dataset.key;

	grid.addEventListener("click", (e) => {
		const card = e.target.closest(".card");
		if (!card) return;

		if (e.ctrlKey || e.metaKey) {
			const href = card.href;
			if (href) window.open(href, "_blank");

			e.preventDefault();
			e.stopPropagation();
			e.stopImmediatePropagation();
			return false;
		}
	}, true);

	const showNoResults = (term) => {
		if (window.allCards.length === 0) {
			grid.innerHTML = `<div class="no-results">0 søgeresultater for "<strong>${term}</strong>".</div>`;
		}
	};

	const sortAllCards = () => {
		window.allCards.sort((a, b) => Number(b.dataset.timestamp) - Number(a.dataset.timestamp));
	};

	const renderNextBatch = () => {
		const nextBatch = window.allCards.slice(currentIndex, currentIndex + BATCH_SIZE);
		if (nextBatch.length === 0) return;
		const fragment = document.createDocumentFragment();
		nextBatch.forEach(card => fragment.appendChild(card));
		grid.insertBefore(fragment, sentinel);
		currentIndex += nextBatch.length;
	};

	const handleScroll = () => {
		if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 200) {
			renderNextBatch();
		}
	};

	window.sortAndRender = () => {
		sortAllCards();
		grid.innerHTML = "";
		grid.appendChild(sentinel);
		currentIndex = 0;
		renderNextBatch();
		observer.observe(sentinel);
	};

	const insertNewCardsAnimated = (newCards) => {
		const fragment = document.createDocumentFragment();
		newCards.forEach(card => {
			card.classList.add('new-card');
			fragment.appendChild(card);
			requestAnimationFrame(() => card.classList.remove('new-card'));
		});
		grid.insertBefore(fragment, grid.firstChild);
	};

	window.startSpinner = () => {
		spinner.classList.add("active");
		input.disabled = true;
	};
	window.stopSpinner = () => {
		spinner.classList.remove("active");
		input.disabled = false;
	};

	const magicSpan = (id, terms, displayTerm) => {
		const span = document.getElementById(id);
		if (!span) return;

		span.addEventListener('click', async () => {
			if (spinner.classList.contains("active")) return;

			const catObj = categories[selectedCategory];
			input.value = "";
			input.disabled = true;
			spinner.classList.add("active");
			window.allCards = [];
			window.totalAds = 0;
			window.loadedAds = 0;
			currentIndex = 0;
			window.removeEventListener('scroll', handleScroll);
			window.seenAdKeys.clear();

			try {
				window.isMagicMode = true;

				const bgEnabled = bgToggle.checked;
				if (bgEnabled && window.bgSearch) {
					window.bgSearch.clear();
					terms.forEach(term => window.bgSearch.addActiveSearch(term, catObj));
				}

				for (const term of terms) {
					await window.hentOgVisGG(term, catObj, false);
					await window.hentOgVisDBA(term, catObj.dbaCat, false);
					await window.hentOgVisReshopper(term, false, catObj.reshopperFacetValue);
				}

				const seenKeys = new Set();
				window.allCards = window.allCards.filter(card => {
					const key = cardKey(card);
					if (seenKeys.has(key)) return false;
					seenKeys.add(key);
					return true;
				});

				insertNewCardsAnimated(window.allCards);
				window.loadedAds = window.totalAds = window.allCards.length;
				window.sortAndRender();
				showNoResults(displayTerm);

				if (bgEnabled && window.bgSearch) {
					window.bgSearch.setBaseline();
				} else {
					window.pendingBgSearches = terms.map(term => ({
						term,
						catObj
					}));
					if (window.bgSearch) window.bgSearch.clear();
				}
			} catch (err) {
				console.error("Fejl i magicSpan-søgning:", err);
			} finally {
				input.disabled = false;
				spinner.classList.remove("active");

				window.isMagicMode = false;
			}
		});
	};

	const defaultLi = categoryMenu.querySelector('ul:first-of-type > li[data-value="mobler"]');
	if (defaultLi) defaultLi.classList.add('active');

	const overlay = document.createElement('div');
	overlay.className = 'menu-overlay';

	categoryButton.addEventListener('click', (e) => {
		e.preventDefault();
		if (categoryMenu.style.display === 'block') {
			categoryMenu.style.display = 'none';
			if (overlay.parentNode) overlay.parentNode.removeChild(overlay);
		} else {
			categoryMenu.style.display = 'block';
			document.body.appendChild(overlay);
		}
	});

	overlay.addEventListener('click', () => {
		categoryMenu.style.display = 'none';
		if (overlay.parentNode) overlay.parentNode.removeChild(overlay);
	});

	input.addEventListener("focus", function() {
		this.select();
	});

	categoryMenu.querySelectorAll('.categories-list > li').forEach(li => {
		li.addEventListener('click', (e) => {
			selectedCategory = li.dataset.value;
			categoryMenu.querySelectorAll('.categories-list > li').forEach(item => item.classList.remove('active'));
			li.classList.add('active');
			categoryMenu.style.display = 'none';
			if (overlay.parentNode) overlay.parentNode.removeChild(overlay);
			if (input.value.trim()) form.requestSubmit();
			e.stopPropagation();
		});
	});

	document.querySelectorAll('.locations-list input[type="checkbox"]').forEach(checkbox => {
		checkbox.addEventListener('change', () => {
			if (input.value.trim()) form.requestSubmit();
		});
	});


	form.addEventListener("submit", async (e) => {
		e.preventDefault();
		const term = input.value.trim();
		if (!term) return;

		const catObj = categories[selectedCategory];
		input.disabled = true;
		spinner.classList.add("active");

		if (isFirstSearch) {
			grid.innerHTML = "";
			isFirstSearch = false;
		}
		window.allCards = [];
		window.totalAds = 0;
		window.loadedAds = 0;
		currentIndex = 0;
		window.removeEventListener('scroll', handleScroll);
		window.seenAdKeys.clear();

		if (window.bgSearch) window.bgSearch.clear();

		try {
			await Promise.all([
				window.hentOgVisGG(term, catObj, false),
				window.hentOgVisDBA(term, catObj.dbaCat, false),
				window.hentOgVisReshopper(term, false, catObj.reshopperFacetValue)
			]);

			await new Promise(resolve => setTimeout(resolve, 0));
			window.loadedAds = window.totalAds;
			window.sortAndRender();

			if (bgToggle.checked && window.bgSearch) {
				window.bgSearch.addActiveSearch(term, catObj);
				window.bgSearch.setBaseline();
			} else {
				window.pendingBgSearches = [{
					term,
					catObj
				}];
			}

			showNoResults(term);
		} catch (err) {
			console.error("Fejl i søgning:", err);
		} finally {
			input.disabled = false;
			spinner.classList.remove("active");
		}
	});

	magicSpan("rat", ["Jason", "Rolschau", "Glostrup møbelfabrik", "Brande møbelindustri", "Østervig"], "gode sager");
	magicSpan("hvidt", ["bord", "skrivebord", "sofa", "sofabord", "spisebord", "skænk", "stol", "lænestol", "hvilestol", "palisander", "retro"], "generelle sager");
})();

(() => {
	const PROXY = "https://corsproxy.io/?";
	window.cityToZip = {};

	async function loadPostnumre() {
		try {
			const res = await fetch(`${PROXY}https://api.dataforsyningen.dk/postnumre`);
			const data = await res.json();
			data.forEach(entry => {
				const city = entry.navn.trim();
				if (!window.cityToZip[city]) window.cityToZip[city] = [];
				window.cityToZip[city].push(entry.nr);
			});
			console.log("Postnumre hentet:", Object.keys(window.cityToZip).length);
		} catch (err) {
			console.error("Kunne ikke hente postnumre:", err);
		}
	}

	window.getZipForCity = (cityName) => {
		if (!cityName) return "";
		const zips = window.cityToZip[cityName.trim()];
		return zips && zips.length ? zips.join(", ") : "";
	};

	loadPostnumre();
})();
    </script>
  </body>
</html>
