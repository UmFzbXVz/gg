<!DOCTYPE html>
<html lang="da">
<head>
<meta charset="UTF-8">
<title>GG</title>
<link rel="stylesheet" href="style.css">
<link rel="icon" type="image/png" href="favicon.png">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
</head>
<body>

<div class="page-container">
  <h1><span class="gg-highlight">Gul og Gratis</span></h1>
  <form id="searchForm" class="controls">
    <div class="input-wrapper">
      <input type="text" id="searchTerm" placeholder="søg efter..." autocomplete="off" />
      <div class="spinner" id="loadingSpinner"></div>
    </div>
    <div class="filter-wrapper">
      <button id="filterButton" class="filter-button" type="button">
        <img src="https://www.svgrepo.com/show/502848/sort.svg" alt="Filter icon" class="filter-icon" />
      </button>
      <div id="filterMenu" class="filter-menu">
        <div class="toggle-container">
          <label for="sortToggle" class="toggle-label">Relevans</label>
          <label class="switch">
            <input type="checkbox" id="sortToggle" checked>
            <span class="slider round"></span>
          </label>
          <label for="sortToggle" class="toggle-label">Senest oprettet</label>
        </div>
      </div>
    </div>
  </form>
  <div id="grid">
    <!-- cards -->
  </div>
</div>

<script>
const PROXY = "https://corsproxy.io/?";
const API_URL = "https://api.guloggratis.dk/graphql";

const HEADERS = {
    "accept": "*/*",
    "accept-encoding": "gzip, deflate",
    "accept-language": "en-US,en;q=0.9",
    "apollo-require-preflight": "true",
    "content-type": "application/json",
    "origin": "https://www.guloggratis.dk",
    "referer": "https://www.guloggratis.dk/",
    "user-agent": "Dalvik/2.1.0 (Linux; U; Android 13; SM-G960F Build/TQ3A.230901.001) GGApp/8.4.4 EmbeddedBrowser",
    "x-client-idfa": "granted",
    "x-client-type": "android",
    "x-client-version": "8.4.4",
    "x-requested-with": "dk.guloggratis"
};

const GRAPHQL_QUERY = `query Search($filters: SearchFiltersInput!, $pagination: PaginationInput!, $currentUrl: String!) {
  redirect(url: $currentUrl)
  search(filters: $filters, pagination: $pagination) {
    pagination { total hasPrevious hasNext __typename }
    listings {
      id title description url
      price { text raw __typename }
      primaryImage { url(size: Listing320) __typename }
      city zipcode
    }
  }
}`;

let currentPage = 1;
let currentTerm = "";
let currentSorting = "LastCreated";
let hasNextPage = false;
let isLoading = false;

const form = document.getElementById("searchForm");
const input = document.getElementById("searchTerm");
const grid = document.getElementById("grid");
const spinner = document.getElementById("loadingSpinner");
const filterButton = document.getElementById("filterButton");
const filterMenu = document.getElementById("filterMenu");
const sortToggle = document.getElementById("sortToggle");

form.addEventListener("submit", async (e) => {
  e.preventDefault();
  const søgeord = input.value.trim();
  if (!søgeord) return;

  currentTerm = søgeord;
  await performSearch();
});

filterButton.addEventListener("click", (e) => {
  e.stopPropagation();
  filterMenu.classList.toggle("open");
});

document.addEventListener("click", (e) => {
  if (!filterButton.contains(e.target) && !filterMenu.contains(e.target)) {
    filterMenu.classList.remove("open");
  }
});

sortToggle.addEventListener("change", async () => {
  currentSorting = sortToggle.checked ? "LastCreated" : "Relevancy";
  if (currentTerm) {
    await performSearch();
  }
});

async function performSearch() {
  currentPage = 1;
  grid.innerHTML = "";
  input.disabled = true;
  filterButton.disabled = true;
  sortToggle.disabled = true;
  spinner.classList.add("active");

  await hentOgVisSide(currentPage);

  input.disabled = false;
  filterButton.disabled = false;
  sortToggle.disabled = false;
  spinner.classList.remove("active");
}

async function hentSide(page, term, sorting) {
  const body = {
    operationName: "Search",
    variables: {
      filters: {
        weapons: true,
        term: term,
        sorting: sorting,
        categoryFields: []
      },
      pagination: {
        perPage: 60,
        page: page
      },
      currentUrl: "/s"
    },
    query: GRAPHQL_QUERY
  };

  const res = await fetch(PROXY + API_URL, {
    method: "POST",
    headers: HEADERS,
    body: JSON.stringify(body)
  });

  if (!res.ok) throw new Error(`Fejl ved hentning af side ${page}: ${res.status}`);
  return res.json();
}

async function hentOgVisSide(page) {
  if (isLoading) return;
  isLoading = true;

  try {
    const data = await hentSide(page, currentTerm, currentSorting);
    const searchData = data?.data?.search || {};

    hasNextPage = searchData?.pagination?.hasNext;
    const listings = searchData.listings || [];
    
    if (page === 1 && listings.length === 0) {
      grid.innerHTML = `<div class="no-results">0 søgeresultater for "<strong>${currentTerm}</strong>".</div>`;
      return;
    }

    listings.forEach(({ id, title, price, url, primaryImage, city, zipcode }) => {
      const card = document.createElement("a");
      card.className = "card";
      card.href = "https://www.guloggratis.dk" + url;
      card.target = "_blank";
      card.rel = "noopener noreferrer";

      const location = [city, zipcode].filter(Boolean).join(" ") || "";

      card.innerHTML = `
        <img loading="lazy" src="${primaryImage?.url || ''}" alt="${title}" />
        <div class="card-content">
          <h3>${title}</h3>
          <div class="card-footer">
            <span class="location">${location}</span>
            <span class="price">${price?.text || ""}</span>
          </div>
        </div>
      `;

      grid.appendChild(card);
    });
  } catch (err) {
    console.error("Fejl:", err.message);
  } finally {
    isLoading = false;
  }
}

const sentinel = document.createElement("div");
sentinel.id = "sentinel";
document.body.appendChild(sentinel);

const observer = new IntersectionObserver(async (entries) => {
  if (entries[0].isIntersecting && hasNextPage && !isLoading) {
    currentPage++;
    await hentOgVisSide(currentPage);
  }
}, { rootMargin: "200px" });

observer.observe(sentinel);
</script>

</body>
</html>
